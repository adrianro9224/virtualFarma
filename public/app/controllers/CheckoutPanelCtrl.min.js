farmapp.controller("CheckoutPanelCtrl",["$scope","$rootScope","$log","$cookies","$http","ConstantsService","$window","UtilService",function(o,e,t,n,r,a,s,i){"use strict";function p(e){switch(e){case"shippingData":o.shippingData||(o.shippingData=!0,o.paymentMethod=!1,o.orderSummary=!1);break;case"paymentMethod":o.paymentMethod||(o.paymentMethod=!0,o.shippingData=!1,o.orderSummary=!1);break;case"orderSummary":o.orderSummary||(o.orderSummary=!0,o.paymentMethod=!1,o.shippingData=!1)}}function c(o){n.putObject("order",o)}function d(e){o.order.shoppingcart.products[e].cant>1&&(o.order.shoppingcart.products[e].cant--,o.order.shoppingcart.numOfproductsTotal--)}function g(e){o.order.shoppingcart.products[e].cant++,o.order.shoppingcart.numOfproductsTotal++}function u(e){o.order.shoppingcart.products.splice(e,1),o.order.shoppingcart.numOfproductsTotal--,o.order.shoppingcart.numOfproductsSubtotal--}function l(){function e(){var e={zoom:15};r=new google.maps.Map(document.getElementById("checkout-map-canvas"),e),navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){var n=new google.maps.LatLng(e.coords.latitude,e.coords.longitude),a=(new google.maps.InfoWindow({map:r,position:n,content:"Estás aquí! :)"}),new google.maps.Marker({position:n,map:r,title:"Esta es tu posición!"}));google.maps.event.addListener(r,"center_changed",function(){window.setTimeout(function(){r.panTo(a.getPosition())},3e3)}),t(e.coords.latitude,e.coords.longitude),m(e.coords.latitude,e.coords.longitude),console.info(o.order),r.setCenter(n)},function(){n(!0)}):n(!1)}function t(e,t){var n=new google.maps.Geocoder,a=new google.maps.LatLng(e,t);n.geocode({latLng:a},function(e,t){if(t==google.maps.GeocoderStatus.OK)if(e[1]){{new google.maps.Marker({position:a,map:r})}o.order.shippingData.addressLine1=e[1].address_components[0].long_name,o.order.shippingData.neighborhood=e[1].address_components[1].long_name,c(o.order)}else alert("No results found");else alert("Geocoder failed due to: "+t)})}function n(o){if(o)var e="Error: The Geolocation service failed.";else var e="Error: Your browser doesn't support geolocation.";{var t={map:r,position:new google.maps.LatLng(60,105),content:e};new google.maps.InfoWindow(t)}r.setCenter(t.position)}var r;google.maps.event.addDomListener(window,"load",e)}function m(e,t){function n(e,t){if("OK"===t){console.info(e.rows);var n=r(e.rows);Array.prototype.max=function(){return Math.max.apply(null,this)},Array.prototype.min=function(){return Math.min.apply(null,this)};var a=n.min(),s=void 0;angular.forEach(e.rows,function(o,e){"OK"===o.elements[0].status&&o.elements[0].distance.value==a&&(s=e)}),o.order.shippingData.FarmacyNearbyId=s,c(o.order)}}function r(o){var e=[];return angular.forEach(o,function(o,t){"OK"===o.elements[0].status&&(e[t]=o.elements[0].distance.value)}),e}var a=new google.maps.LatLng(e,t),s=new google.maps.DistanceMatrixService;s.getDistanceMatrix({origins:O,destinations:[a],travelMode:google.maps.TravelMode.DRIVING,unitSystem:google.maps.UnitSystem.METRIC,durationInTraffic:!0,avoidHighways:!0,avoidTolls:!0},n)}o.shippingData=!0,o.paymentMethod=!1,o.orderSummary=!1,o.shippingDataComplete=!1,o.paymentMethodComplete=!1,o.orderSummaryEnable=!1,o.checkoutCurrentStep="shippingData";var h=n.getObject("order"),f=n.getObject("shoppingcart"),O=[new google.maps.LatLng(a.GALERIAS_GEOMETRY_LOCATION.lat,a.GALERIAS_GEOMETRY_LOCATION.lng),new google.maps.LatLng(a.CAMPIN_GEOMETRY_LOCATION.lat,a.CAMPIN_GEOMETRY_LOCATION.lng),new google.maps.LatLng(a.PORCIUNCULA_GEOMETRY_LOCATION.lat,a.PORCIUNCULA_GEOMETRY_LOCATION.lng),new google.maps.LatLng(a.ANDES_GEOMETRY_LOCATION.lat,a.ANDES_GEOMETRY_LOCATION.lng),new google.maps.LatLng(a.CASTELLANA_GEOMETRY_LOCATION.lat,a.CASTELLANA_GEOMETRY_LOCATION.lng)];l(),void 0==h||void 0==f||h.sended?(o.order={},void 0!=f?o.order.shoppingcart=f:window.location="/account/log_in",c(o.order)):(h.shoppingcart=f,o.order=h,o.checkoutCurrentStep=h.currentStep,c(h),p(o.checkoutCurrentStep)),t.log(o.order),o.openSection=function(o){p(o)},o.stepCompleted=function(e,t){switch(t){case"shippingData":e.shippingData.status=!0,e.currentStep="paymentMethod",o.shippingDataComplete=!0,c(e),p(e.currentStep);break;case"paymentMethod":e.paymentMethod.status=!0,e.currentStep="orderSummary",o.paymentMethodComplete=!0,c(e),p(e.currentStep);break;case"orderSummary":o.sendingOrder=!0;var d=e;d.date=i.getDateMySql(),d.from="WEB",d.points=d.shoppingcart.subtotal*a.POINTS_BASE,r.post("http://virtualfarma.com.co/checkout/create_order",{data:d}).success(function(t){"true"==t?(e.sended=!0,o.sendingOrder=!1,n.remove("shoppingcart"),c(e)):(o.sendingOrder=!1,console.info(t))}).error(function(o){s.location.reload(),console.info(o+":(")})}},o.changeUseAccountDataStatus=function(){c(o.order)},o.recalculateTotals=function(){if(void 0!=arguments){switch(arguments[1]){case"decrease":d(arguments[0]);break;case"increase":g(arguments[0]);break;case"delete":u(arguments[0]);break;default:(!angular.isNumber(o.order.shoppingcart.products[arguments[0]].cant)||o.order.shoppingcart.products[arguments[0]].cant<1)&&(o.order.shoppingcart.products[arguments[0]].cant=1)}0==o.order.shoppingcart.numOfproductsTotal&&(o.order.shoppingcart.haveProducts=!1)}e.$broadcast(a.SHOPPINGCART_CHANGED,o.order.shoppingcart)},o.reedemPoints=function(t){var n=parseInt(t),r=n%100,s=n-r;o.order.shoppingcart.hasDiscount?(o.order.shoppingcart.hasDiscount=!1,o.order.shoppingcart.subtotal+=s):(o.order.shoppingcart.pointsDoDiscount=s,o.order.shoppingcart.hasDiscount=!0),e.$broadcast(a.SHOPPINGCART_CHANGED,o.order.shoppingcart)}}]);