farmapp.controller("SalesCreatorCtrl",["$scope","$rootScope","$http","$filter","$cookies","UtilService","ConstantsService","$location",function(a,t,o,s,e,n,r){"use strict";function p(){a.productsCharged=!1,o.get("http://virtualfarma.com.co/admin/all_products").success(function(t){if("NULL"!=o){var o=angular.fromJson(t);a.productsCharged=!0,a.products=o}else console.info(t+":(")}).error(function(a){console.info(a+":(")})}function i(t){switch(t){case"shippingData":a.shippingData||(a.shippingData=!0,a.productsToSale=!1,a.orderSummary=!1);break;case"productsToSale":a.productsToSale||(a.productsToSale=!0,a.shippingData=!1,a.orderSummary=!1);break;case"orderSummary":a.orderSummary||(a.orderSummary=!0,a.productsToSale=!1,a.shippingData=!1)}}function c(a){e.putObject("sale",a)}function l(a){console.info(a);var t=parseFloat(a.price),o=null==a.discount?0:parseInt(a.discount),s=null==a.tax?0:parseFloat(a.tax),e=new Object;return e.PLU=a.PLU,e.name=a.name,e.barcode=a.barcode,e.categoryId=a.category_id,e.presentation=a.presentation,e.cant=a.cant,e.tax=0==s?0:s,e.price=t,e.discount=0==o?0:o,e}function u(a){var t;return t=a>=r.LIMIT_FOR_FREE_SHIPPING?"Es gratis":r.SHIPPING_CHARGE}function g(a){var t=0,o=0;angular.forEach(a,function(a){t+=a.price*a.cant,o+=a.tax*a.price});var s={productsSubtotal:t,productsTaxTotal:o};return s}function d(t){a.sale.shoppingcart.products[t].cant>1&&(a.sale.shoppingcart.products[t].cant--,a.sale.shoppingcart.numOfproductsTotal--)}function h(t){a.sale.shoppingcart.products[t].cant++,a.sale.shoppingcart.numOfproductsTotal++}function m(t){a.sale.shoppingcart.products.splice(t,1),a.sale.shoppingcart.numOfproductsTotal--,a.sale.shoppingcart.numOfproductsSubtotal--}function f(a,t){function o(){s=new google.maps.Map(document.getElementById("my-map"),{zoom:16,center:{lat:a,lng:t}})}var s;google.maps.event.addDomListener(window,"load",o())}function O(t){function o(t,o){if("OK"===o){console.info(t.rows);var e=s(t.rows);Array.prototype.max=function(){return Math.max.apply(null,this)},Array.prototype.min=function(){return Math.min.apply(null,this)};var n=e.min(),r=void 0;angular.forEach(t.rows,function(a,t){"OK"===a.elements[0].status&&a.elements[0].distance.value==n&&(r=t)}),a.sale.shippingData.FarmacyNearbyId=r,c(a.sale)}}function s(a){var t=[];return angular.forEach(a,function(a,o){"OK"===a.elements[0].status&&(t[o]=a.elements[0].distance.value)}),t}var e=new google.maps.LatLng(t.lat,t.lng),n=new google.maps.DistanceMatrixService;n.getDistanceMatrix({origins:L,destinations:[e],travelMode:google.maps.TravelMode.DRIVING,unitSystem:google.maps.UnitSystem.METRIC,durationInTraffic:!0,avoidHighways:!0,avoidTolls:!0},o)}a.productsToSale=!0,a.shippingData=!1,a.orderSummary=!1,a.productsToSaleComplete=!1,a.shippingDataComplete=!1,a.orderSummaryEnable=!1,a.checkoutCurrentStep="shippingData";var S=r.LIMIT_PAYU_ORDER_VALUE,v=r.MINIMUM_ORDER_VALUE,T=r.LIMIT_FOR_FREE_SHIPPING,E=r.POINTS_BASE,L=[new google.maps.LatLng(r.GALERIAS_GEOMETRY_LOCATION.lat,r.GALERIAS_GEOMETRY_LOCATION.lng),new google.maps.LatLng(r.CAMPIN_GEOMETRY_LOCATION.lat,r.CAMPIN_GEOMETRY_LOCATION.lng),new google.maps.LatLng(r.PORCIUNCULA_GEOMETRY_LOCATION.lat,r.PORCIUNCULA_GEOMETRY_LOCATION.lng),new google.maps.LatLng(r.ANDES_GEOMETRY_LOCATION.lat,r.ANDES_GEOMETRY_LOCATION.lng),new google.maps.LatLng(r.CASTELLANA_GEOMETRY_LOCATION.lat,r.CASTELLANA_GEOMETRY_LOCATION.lng)];a.mouseover=!1,a.showSubmitButtonTooltip=function(){a.mouseover=!0},a.hideSubmitButtonTooltip=function(){a.mouseover=!1};var I=new Date,A=I.getDate();I.setDate(A+1);var C={path:"/admin",expires:I},_=e.getObject("sale");void 0!=_&&(a.sale=_,a.subtotal=_.shoppingcart.subtotal,a.shippingCharge=_.shoppingcart.shippingCharge,a.tax=_.shoppingcart.tax,a.total=_.shoppingcart.total,console.info(_),i(_.currentStep)),p(),a.search=function(t){if(t.length>2){var o=s("filter")(a.products,t,void 0);a.results=o.length>0?o:!1}else a.results=!1},a.putSaveAndSound=function(a,t){void 0==arguments[2]?void 0!=a&&t&&c(a):1==arguments[2]&&c(a)},a.openSection=function(a){i(a)},a.doNewOrder=function(){e.remove("sale"),window.location="admin/admin_login"},a.stepCompleted=function(t,s){switch(s){case"productsToSale":t.shoppingcart.products.status=!0,t.currentStep="shippingData",a.paymentMethodComplete=!0,c(t),i(t.currentStep);break;case"shippingData":t.shippingData.status=!0,t.currentStep="orderSummary",a.shippingDataComplete=!0,c(t),i(t.currentStep);break;case"orderSummary":a.sendingOrder=!0;var p=t;p.date=n.getDateMySql(),p.from="CALL_CENTER",p.points=p.shoppingcart.subtotal*r.POINTS_BASE,o.post("http://virtualfarma.com.co/checkout/create_order",{data:p}).success(function(o){"true"==o?(t.sended=!0,a.sendingOrder=!1,e.remove("sale"),c(t)):(a.sendingOrder=!1,console.info(o))}).error(function(a){console.info(a+":(")})}},a.addToShoppingCart=function(o){var s=n.isInteger(o.cant);if(s){var e=parseInt(o.cant,10);if(void 0!=a.sale&&a.sale.shoppingcart.haveProducts){if(void 0!=a.sale.shoppingcart&&void 0!=a.sale.shoppingcart.products){var p=l(o),i=a.sale.shoppingcart.products,c=!1;angular.forEach(i,function(t,s){void 0!=t&&o.PLU==t.PLU&&(c=!0,a.sale.shoppingcart.products[s].cant+=e,a.sale.shoppingcart.numOfproductsTotal+=e)}),c||(a.sale.shoppingcart.products[a.sale.shoppingcart.numOfproductsSubtotal]=p,a.sale.shoppingcart.numOfproductsSubtotal++,a.sale.shoppingcart.numOfproductsTotal+=e)}}else{a.sale={},a.sale.paymentMethod={},a.sale.paymentMethod.selectedPaymentMethod=1,a.sale.shoppingcart={},a.sale.shoppingcart.products=[{}],a.sale.shoppingcart.subtotal=0,a.sale.shoppingcart.shippingCharge=0,a.sale.shoppingcart.tax=0,a.sale.shoppingcart.total=0,a.sale.shoppingcart.numOfproductsSubtotal=0,a.sale.shoppingcart.numOfproductsTotal=0,a.sale.shoppingcart.limitOrderValueInvalid=!1,a.sale.shoppingcart.minimumOrderValueInvalid=!1,a.sale.shoppingcart.hasDiscount=!1,a.sale.shoppingcart.pointsBase=void 0!=E?E:r.POINTS_BASE,a.sale.shoppingcart.sended=!1;var u=l(o);a.sale.shoppingcart.products[a.sale.shoppingcart.numOfproductsSubtotal]=u,a.sale.shoppingcart.numOfproductsSubtotal++,a.sale.shoppingcart.numOfproductsTotal+=e,a.sale.shoppingcart.haveProducts=!0}console.info(a.sale),t.$broadcast(r.SALE_CHANGED,a.sale)}},t.$on(r.SALE_CHANGED,function(t,o){a.sale=o;var s;s=g(a.sale.shoppingcart.products),a.sale.shoppingcart.subtotal=s.productsSubtotal,a.sale.shoppingcart.tax=s.productsTaxTotal;var n=a.sale.shoppingcart.subtotal;a.sale.shoppingcart.hasDiscount&&(a.sale.shoppingcart.subtotal-=a.sale.shoppingcart.pointsDoDiscount,n+=a.sale.shoppingcart.pointsDoDiscount);var r=u(n);a.sale.shoppingcart.shippingCharge=r,angular.isString(r)?(a.sale.shoppingcart.total=a.sale.shoppingcart.subtotal+a.sale.shoppingcart.tax,a.sale.shoppingcart.shippingFree=!0):(a.sale.shoppingcart.total=a.sale.shoppingcart.subtotal+a.sale.shoppingcart.tax+a.sale.shoppingcart.shippingCharge,a.sale.shoppingcart.shippingFree=!1),a.shippingCharge=a.sale.shoppingcart.shippingCharge,a.subtotal=a.sale.shoppingcart.subtotal,void 0!=v&&(a.sale.shoppingcart.minimumOrderValue=v,a.sale.shoppingcart.minimumOrderValueInvalid=a.sale.shoppingcart.subtotal<v?!0:!1),void 0!=S&&a.sale.shoppingcart.total>S&&(a.sale.shoppingcart.limitOrderValueInvalid=!0),void 0!=T&&(a.sale.shoppingcart.limitForFreeShipping=T),a.total=a.sale.shoppingcart.total,e.putObject("sale",a.sale,C)}),a.removeProduct=function(o){a.sale.shoppingcart.products[o].cant>1?(a.sale.shoppingcart.products[o].cant--,a.sale.shoppingcart.numOfproductsTotal--):(a.sale.shoppingcart.products.splice(o,1),a.sale.shoppingcart.numOfproductsTotal--,a.sale.shoppingcart.numOfproductsSubtotal--),0==a.sale.shoppingcart.numOfproductsTotal&&(a.sale.shoppingcart.haveProducts=!1),t.$broadcast(r.SALE_CHANGED,a.sale)},a.recalculateTotals=function(){if(void 0!=arguments){switch(arguments[1]){case"decrease":d(arguments[0]);break;case"increase":h(arguments[0]);break;case"delete":m(arguments[0]);break;default:(!angular.isNumber(a.sale.shoppingcart.products[arguments[0]].cant)||a.sale.shoppingcart.products[arguments[0]].cant<1)&&(a.sale.shoppingcart.products[arguments[0]].cant=1)}0==a.sale.shoppingcart.numOfproductsTotal&&(a.sale.shoppingcart.haveProducts=!1)}t.$broadcast(r.SALE_CHANGED,a.sale)},a.reedemPoints=function(o){console.info(o);var s=parseInt(o),e=s%100,n=s-e;a.sale.shoppingcart.hasDiscount?(a.sale.shoppingcart.hasDiscount=!1,a.sale.shoppingcart.subtotal+=n):(a.sale.shoppingcart.pointsDoDiscount=n,a.sale.shoppingcart.hasDiscount=!0),t.$broadcast(r.SALE_CHANGED,a.sale)},a.DoGeoCoding=function(a){o.get("http://maps.googleapis.com/maps/api/geocode/json?address="+a).success(function(a){if("OK"==a.status){var t={lat:a.results[0].geometry.location.lat,lng:a.results[0].geometry.location.lng};O(t),f(a.results[0].geometry.location.lat,a.results[0].geometry.location.lng)}}).error(function(a){console.info(a+":(")})}}]);